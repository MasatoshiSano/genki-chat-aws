# 設計定義書

---

## 1. システム概要  
本システムは、AWS Bedrock の Agent を利用して「元気をくれる」チャット応答を実現するWebアプリです。  
ユーザーはアカウントを作成・ログインし、個別のチャット履歴を閲覧・管理できます。  
フロントエンドは CloudFront と S3 で配信される SPA で、バックエンドは API Gateway と Lambda で構成します。

---

## 2. 画面構成・機能一覧

### 2-1. ログイン画面  
- **機能**：  
  - ユーザーのメールアドレスとパスワードでログイン  
  - パスワードを忘れた場合のリセットリンク  
  - 新規登録画面への遷移ボタン  
- **ポイント**：Cognito Hosted UI またはカスタムUIで実装可能

---

### 2-2. 新規登録画面  
- **機能**：  
  - メールアドレス、パスワードを入力しアカウントを作成  
  - メール認証を完了してから利用開始可能  
- **ポイント**：Cognito がメール送信を管理

---

### 2-3. チャット画面（メイン画面）  
- **機能**：  
  - ユーザーのテキスト入力と送信  
  - Bedrock Agent からの応答を吹き出し形式で表示  
  - 過去のチャット履歴の参照とスクロール  
  - チャット履歴の削除（セッション単位）  
- **ポイント**：  
  - 送受信メッセージは DynamoDB に保存  
  - 応答はモチベーション強化型に最適化済み

---

### 2-4. 履歴一覧画面  
- **機能**：  
  - 過去のチャットセッションを日時順にリスト表示  
  - 各セッションの冒頭メッセージをプレビュー表示  
  - セッションを選択するとチャット画面に復元  
- **ポイント**：ユーザーごとに表示を制限

---

### 2-5. 設定画面（任意）  
- **機能**：  
  - プロフィール編集（表示名、プロフィール画像）  
  - テーマ（ライト／ダークモード）切替  
  - ログアウト  
- **ポイント**：S3 に画像を保存し、Cognito属性にも連携可

---

## 3. API設計

| HTTP メソッド | エンドポイント        | 機能概要                      | リクエストパラメータ                      | レスポンス                              | 認証          |
|---------------|-----------------------|------------------------------|------------------------------------------|----------------------------------------|---------------|
| POST          | /chat                 | ユーザーのメッセージを送信し、Agent応答を取得 | `{ "message": "string" }`                 | `{ "reply": "string" }`                 | 必須（Cognito） |
| GET           | /history              | 過去のチャット履歴一覧を取得    | クエリパラメータ：`limit`（任意）           | `[ { "sessionId": "string", "date": "ISO8601", "preview": "string" }, ... ]` | 必須          |
| GET           | /history/{sessionId}  | 指定セッションの詳細チャット履歴を取得 | パスパラメータ：`sessionId`              | `[ { "timestamp": "ISO8601", "role": "user|agent", "message": "string" }, ... ]` | 必須          |
| DELETE        | /history/{sessionId}  | 指定セッションのチャット履歴を削除 | パスパラメータ：`sessionId`              | `{ "status": "success" }`               | 必須          |

---

## 4. データベース設計（DynamoDB）

### 4-1. ユーザーテーブル (`UserTable`)
| 属性名      | 種類   | 説明                 | 備考           |
|-------------|--------|----------------------|----------------|
| userId      | 文字列 | プライマリキー（PK） | Cognito ユーザーID |
| email       | 文字列 | メールアドレス       | 一意制約       |
| createdAt   | 文字列 | 登録日時             | ISO8601形式    |

### 4-2. チャット履歴テーブル (`ChatHistoryTable`)
| 属性名      | 種類   | 説明                            | 備考                    |
|-------------|--------|---------------------------------|-------------------------|
| userId      | 文字列 | パーティションキー（PK）         | Cognito ユーザーID      |
| sessionId   | 文字列 | ソートキー（SK）                 | 会話セッションID         |
| timestamp   | 文字列 | メッセージ送信日時              | ISO8601形式             |
| role        | 文字列 | メッセージ送信者 ("user" or "agent") |                         |
| message     | 文字列 | メッセージ本文                  |                         |
| sentiment   | 文字列 | 励まし応答生成用の感情メタデータ | （例：ポジティブ, ネガティブ等） |

---

## 5. AWSサービス構成

| コンポーネント      | サービス                  | 機能概要                                    |
|---------------------|---------------------------|---------------------------------------------|
| フロントエンド       | Amazon S3 + CloudFront    | SPA ホスティングと高速CDN配信               |
| 認証・ユーザー管理   | Amazon Cognito            | ユーザー認証・管理                           |
| APIゲートウェイ     | Amazon API Gateway        | REST API 管理と認証連携                      |
| バックエンド処理     | AWS Lambda                | チャット処理、Bedrock Agent 呼び出し         |
| AIモデル推論        | Amazon Bedrock Agent      | 「元気をくれる」チャット応答                  |
| データ保存          | Amazon DynamoDB           | ユーザーデータ・チャット履歴保存             |
| ロギング・監視      | Amazon CloudWatch         | ログ収集・アラート設定                       |

---

## 6. ユーザー認証フロー（概要）

1. ユーザーがログイン画面でメール・パスワードを入力  
2. Cognito が認証し、IDトークンを発行  
3. フロントエンドはAPI呼び出し時に Authorization ヘッダにトークンを付与  
4. API Gateway がトークンを検証しLambdaを呼び出す  
5. Lambda がチャット履歴の読み書きや Bedrock Agent の呼び出しを行う  

---

## 7. チャットフロー（概要）

1. ユーザーがチャット画面からメッセージを送信  
2. メッセージは Lambda 経由で DynamoDB に保存（ユーザー発言）  
3. Lambda から Bedrock Agent を呼び出し、ユーザーの直近履歴を含めて応答を生成  
4. 生成された応答を DynamoDB に保存（Agent発言）  
5. フロントエンドに応答を返し、チャット画面に表示

---

## 8. 拡張・工夫ポイント

- モチベーション強化型応答：  
  Agent の応答に励ましフレーズを追加し、ユーザーの元気づけを強化

- 履歴ベース応答最適化：  
  直近のチャット履歴をプロンプトに含め、会話の一貫性を保つ

---

## 9. 開発・運用の注意点

- API や Lambda のレスポンス時間は 3 秒以内を目標とする  
- DynamoDB はパーティションキー設計を工夫し、アクセス集中に対応  
- セキュリティ面は Cognito でトークン管理を厳格に行う  
- CloudWatch でログを監視し、異常時にアラートを上げる仕組みを用意する  

---

