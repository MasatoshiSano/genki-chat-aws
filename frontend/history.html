<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS Chat - ãƒãƒ£ãƒƒãƒˆå±¥æ­´</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div id="headerContainer">
            <!-- ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="header">
                <div class="header-left">
                    <a href="chat.html" class="back-button">
                        <span>â†</span>
                        ãƒãƒ£ãƒƒãƒˆ
                    </a>
                    <h1>ğŸ“š å±¥æ­´</h1>
                </div>
                <div class="hamburger-menu" id="hamburgerMenu">
                    <button class="hamburger-button" onclick="toggleMenu()">
                        <div class="hamburger-icon">
                            <div class="hamburger-line"></div>
                            <div class="hamburger-line"></div>
                            <div class="hamburger-line"></div>
                        </div>
                    </button>
                    <div class="menu-dropdown">
                        <a href="chat.html" class="menu-item">
                            <span class="menu-icon">ğŸ’¬</span>
                            æ–°è¦ãƒãƒ£ãƒƒãƒˆ
                        </a>
                        <a href="profile.html" class="menu-item">
                            <span class="menu-icon">ğŸ‘¤</span>
                            ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
                        </a>
                        <div class="menu-item" onclick="toggleTheme()" id="themeToggle">
                            <span class="menu-icon">ğŸŒ™</span>
                            ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰
                        </div>
                        <div class="menu-item" onclick="clearAllHistory()">
                            <span class="menu-icon">ğŸ—‘ï¸</span>
                            ã™ã¹ã¦å‰Šé™¤
                        </div>
                        <div class="menu-item logout" onclick="logout()">
                            <span class="menu-icon">ğŸšª</span>
                            ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="content">
            <div id="loadingState" class="loading">
                å±¥æ­´ã‚’èª­ã¿è¾¼ã¿ä¸­...
            </div>
            
            <div id="errorState" class="error-message" style="display: none;"></div>
            
            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="icon">ğŸ’¬</div>
                <h3>ã¾ã ãƒãƒ£ãƒƒãƒˆå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</h3>
                <p>æœ€åˆã®ä¼šè©±ã‚’å§‹ã‚ã¦ã€ç´ æ•µãªæ€ã„å‡ºã‚’ä½œã‚Šã¾ã—ã‚‡ã†ï¼</p>
                <button class="start-chat-button" onclick="goToChat()">ãƒãƒ£ãƒƒãƒˆã‚’å§‹ã‚ã‚‹</button>
            </div>
            
            <div id="historyList" class="history-list" style="display: none;"></div>
        </div>
    </div>

    <!-- ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
    <div class="custom-dialog-overlay" id="deleteConfirmDialog">
        <div class="custom-dialog">
            <div class="dialog-title">
                ğŸ—‘ï¸ ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®å‰Šé™¤
            </div>
            <div class="dialog-message">
                ã“ã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ<br>
                <strong>ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</strong>
            </div>
            <div class="dialog-buttons">
                <button class="dialog-button cancel" onclick="hideDeleteConfirm()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="dialog-button confirm" onclick="confirmDelete()">å‰Šé™¤ã™ã‚‹</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="auth.js"></script>
    <script src="components.js"></script>
    <script>
        const API_BASE_URL = 'https://i6zlozpitk.execute-api.ap-northeast-1.amazonaws.com/prod';
        console.log('API_BASE_URL set to:', API_BASE_URL);
        
        // Cognitoè¨­å®š
        const COGNITO_CONFIG = {
            userPoolId: 'ap-northeast-1_7CLrXZQiB',
            clientId: '7af0tuk3i9r0lir5uhqduiep04',
            clientSecret: '1t87e432carkn9lg6i4tjhmj8brkf7mp1vj8phqhkuljpqtqtnia',
            region: 'ap-northeast-1'
        };
        
        const cognitoAuth = new CognitoAuth(COGNITO_CONFIG);
        let pendingDeleteSessionId = null;
        
        // åŸºæœ¬çš„ãªãƒ¡ãƒ‹ãƒ¥ãƒ¼æ©Ÿèƒ½ã‚’ç¢ºå®Ÿã«æä¾›
        function toggleMenu() {
            const menu = document.getElementById('hamburgerMenu');
            if (menu) {
                menu.classList.toggle('active');
            }
        }

        function logout() {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.clear();
                sessionStorage.clear();
                if (window.cognitoAuth) {
                    cognitoAuth.signOut();
                }
                window.location.href = 'index.html';
            }
        }

        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('hamburgerMenu');
            if (menu && !menu.contains(event.target)) {
                menu.classList.remove('active');
            }
        });

        // é‡è¤‡ã—ãŸåˆæœŸåŒ–å‡¦ç†ã‚’å‰Šé™¤ï¼ˆä¸‹ã®çµ±åˆç‰ˆã‚’ä½¿ç”¨ï¼‰
        
        // ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º
        function showDeleteConfirm(sessionId) {
            pendingDeleteSessionId = sessionId;
            document.getElementById('deleteConfirmDialog').style.display = 'flex';
        }
        
        // ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°éè¡¨ç¤º
        function hideDeleteConfirm() {
            pendingDeleteSessionId = null;
            document.getElementById('deleteConfirmDialog').style.display = 'none';
        }
        
        // å‰Šé™¤å®Ÿè¡Œ
        async function confirmDelete() {
            hideDeleteConfirm();
            if (pendingDeleteSessionId) {
                await performDelete(pendingDeleteSessionId);
            }
        }
        
        // ã™ã¹ã¦ã®å±¥æ­´ã‚’å‰Šé™¤
        async function clearAllHistory() {
            if (!confirm('ã™ã¹ã¦ã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                return;
            }
            
            try {
                showLoading();
                
                // ç¾åœ¨ã®å±¥æ­´ä¸€è¦§ã‚’å–å¾—
                const idToken = cognitoAuth.getIdToken();
                const response = await fetch(`${API_BASE_URL}/history`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('å±¥æ­´ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                const sessions = await response.json();
                console.log('å‰Šé™¤å¯¾è±¡ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°:', sessions.length);
                
                // å„ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
                let deletedCount = 0;
                for (const session of sessions) {
                    try {
                        const deleteResponse = await fetch(`${API_BASE_URL}/history/${session.sessionId}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${idToken}`,
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (deleteResponse.ok) {
                            deletedCount++;
                        }
                    } catch (error) {
                        console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', session.sessionId, error);
                    }
                }
                
                alert(`âœ… ä¸€æ‹¬å‰Šé™¤å®Œäº†\n${deletedCount}ä»¶ã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
                await loadHistory();
                
            } catch (error) {
                console.error('ä¸€æ‹¬å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                alert('ä¸€æ‹¬å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // çµ±åˆåˆæœŸåŒ–å‡¦ç†
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOMContentLoaded fired');
            
            // ãƒ†ãƒ¼ãƒåˆæœŸåŒ–
            initializeTheme();
            
            // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ãŒã‚ã‚Œã°ä½¿ç”¨ã€ãªã‘ã‚Œã°ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            if (typeof componentManager !== 'undefined') {
                try {
                    componentManager.initializeCommon();
                    console.log('ComponentManager initialized successfully');
                } catch (error) {
                    console.error('ComponentManager initialization failed:', error);
                }
            }
            
            // èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèª
            if (!cognitoAuth.restoreSession()) {
                console.log('Authentication failed, redirecting to login');
                window.location.href = 'index.html';
                return;
            }
            
            console.log('Authentication successful, loading history');
            await loadHistory();
        });

        // ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆ
        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ãƒ†ãƒ¼ãƒãƒˆã‚°ãƒ«ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                const icon = newTheme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
                const text = newTheme === 'light' ? 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰' : 'ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰';
                themeToggle.innerHTML = `<span class="menu-icon">${icon}</span> ${text}`;
            }
        }

        // ãƒ†ãƒ¼ãƒã‚’åˆæœŸåŒ–
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', savedTheme);
            
            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ãƒ†ãƒ¼ãƒãƒˆã‚°ãƒ«ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
            setTimeout(() => {
                const themeToggle = document.getElementById('themeToggle');
                if (themeToggle) {
                    const icon = savedTheme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
                    const text = savedTheme === 'dark' ? 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰' : 'ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰';
                    themeToggle.innerHTML = `<span class="menu-icon">${icon}</span> ${text}`;
                }
            }, 100);
        }

        // å±¥æ­´èª­ã¿è¾¼ã¿
        async function loadHistory() {
            console.log('loadHistory function called');
            try {
                const idToken = cognitoAuth.getIdToken();
                console.log('ID Token available:', !!idToken);
                
                const url = `${API_BASE_URL}/history`;
                console.log('Fetching history from:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response body:', errorText);
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const historyData = await response.json();
                console.log('History data received:', historyData);
                displayHistory(historyData);
                
            } catch (error) {
                console.error('å±¥æ­´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showError('å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // å±¥æ­´è¡¨ç¤º
        function displayHistory(historyData) {
            if (!historyData || historyData.length === 0) {
                showEmptyState();
                return;
            }

            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';

            historyData.forEach(session => {
                const historyItem = createHistoryItem(session);
                historyList.appendChild(historyItem);
            });

            historyList.style.display = 'flex';
        }

        // å±¥æ­´ã‚¢ã‚¤ãƒ†ãƒ ä½œæˆ
        function createHistoryItem(session) {
            const item = document.createElement('div');
            item.className = 'history-item';
            
            // ã‚¢ã‚¤ãƒ†ãƒ å…¨ä½“ã®ã‚¯ãƒªãƒƒã‚¯ã§ã¯ãªãã€ã‚³ãƒ³ãƒ†ãƒ³ãƒ„éƒ¨åˆ†ã®ã‚¯ãƒªãƒƒã‚¯ã®ã¿ã§è¡¨ç¤º
            item.onclick = (e) => {
                // ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã¯ä½•ã‚‚ã—ãªã„
                if (e.target.closest('.history-item-actions') || e.target.closest('.history-item-delete')) {
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }
                viewSession(session.sessionId);
            };

            const date = formatDate(session.date);

            item.innerHTML = `
                <div class="history-item-content">
                    <div class="history-date">${date}</div>
                    <div class="history-preview">${session.preview || 'ãƒãƒ£ãƒƒãƒˆå±¥æ­´'}</div>
                </div>
                <div class="history-item-actions">
                    <button class="action-button btn-continue" onclick="event.stopPropagation(); continueSession('${session.sessionId}')">ç¶™ç¶š</button>
                    <button class="action-button btn-view" onclick="event.stopPropagation(); viewSession('${session.sessionId}')">è¡¨ç¤º</button>
                </div>
                <div class="history-item-delete">
                    <button class="action-button btn-delete" onclick="event.stopPropagation(); deleteSession('${session.sessionId}')">ğŸ—‘ï¸</button>
                </div>
            `;

            return item;
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¶™ç¶š
        async function continueSession(sessionId) {
            try {
                const idToken = cognitoAuth.getIdToken();
                const response = await fetch(`${API_BASE_URL}/history/${sessionId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const sessionData = await response.json();
                sessionData.sessionId = sessionId;  // ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’ç¢ºå®Ÿã«è¨­å®š
                
                // ãƒãƒ£ãƒƒãƒˆç”»é¢ã«é·ç§»ã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç¶™ç¶š
                localStorage.setItem('restoreSession', JSON.stringify(sessionData));
                window.location.href = 'chat.html';
                
            } catch (error) {
                console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¶™ç¶šã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ç¶™ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }
        
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³è©³ç´°è¡¨ç¤ºï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ï¼‰
        async function viewSession(sessionId) {
            try {
                const idToken = cognitoAuth.getIdToken();
                const response = await fetch(`${API_BASE_URL}/history/${sessionId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const sessionData = await response.json();
                // æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¨ã—ã¦è¡¨ç¤ºï¼ˆç¶™ç¶šãªã—ï¼‰
                sessionData.sessionId = null;  // æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¨ã—ã¦è¡¨ç¤º
                
                localStorage.setItem('restoreSession', JSON.stringify(sessionData));
                window.location.href = 'chat.html';
                
            } catch (error) {
                console.error('ã‚»ãƒƒã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤ï¼ˆã‚«ã‚¹ã‚¿ãƒ ãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤ºï¼‰
        function deleteSession(sessionId) {
            console.log('å‰Šé™¤è¦æ±‚:', sessionId);
            showDeleteConfirm(sessionId);
        }
        
        // å®Ÿéš›ã®å‰Šé™¤å‡¦ç†
        async function performDelete(sessionId) {
            console.log('=== å‰Šé™¤å‡¦ç†é–‹å§‹ ===');
            console.log('å‰Šé™¤å¯¾è±¡ã‚»ãƒƒã‚·ãƒ§ãƒ³ID:', sessionId);
            console.log('API_BASE_URL:', API_BASE_URL);
            
            // èªè¨¼çŠ¶æ…‹ã‚’è©³ç´°ãƒã‚§ãƒƒã‚¯
            console.log('cognitoAuth:', cognitoAuth);
            console.log('isAuthenticated:', cognitoAuth.isAuthenticated());
            
            if (!cognitoAuth.isAuthenticated()) {
                alert('èªè¨¼ãŒç„¡åŠ¹ã§ã™ã€‚å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚');
                window.location.href = 'index.html';
                return;
            }

            try {
                console.log('å‰Šé™¤å‡¦ç†ã‚’é–‹å§‹:', sessionId);
                const idToken = cognitoAuth.getIdToken();
                console.log('IDãƒˆãƒ¼ã‚¯ãƒ³è©³ç´°:');
                console.log('- å­˜åœ¨:', !!idToken);
                console.log('- é•·ã•:', idToken ? idToken.length : 0);
                console.log('- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:', idToken ? idToken.substring(0, 50) + '...' : 'ãªã—');
                
                if (!idToken) {
                    throw new Error('èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
                }
                
                const url = `${API_BASE_URL}/history/${sessionId}`;
                console.log('å‰Šé™¤URL:', url);
                
                console.log('ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ä¸­...');
                const response = await fetch(url, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${idToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('=== APIå¿œç­” ===');
                console.log('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', response.status);
                console.log('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ã‚­ã‚¹ãƒˆ:', response.statusText);
                console.log('ãƒ˜ãƒƒãƒ€ãƒ¼:', Object.fromEntries(response.headers.entries()));

                if (!response.ok) {
                    const errorData = await response.text();
                    console.error('ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹æœ¬æ–‡:', errorData);
                    
                    let parsedError;
                    try {
                        parsedError = JSON.parse(errorData);
                    } catch (e) {
                        parsedError = { error: errorData };
                    }
                    
                    throw new Error(`å‰Šé™¤å¤±æ•— (${response.status}): ${parsedError.error || response.statusText}`);
                }

                const result = await response.json();
                console.log('=== å‰Šé™¤æˆåŠŸ ===');
                console.log('çµæœ:', result);

                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                alert(`âœ… å‰Šé™¤å®Œäº†\n${result.deletedCount}ä»¶ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);

                // å±¥æ­´ã‚’å†èª­ã¿è¾¼ã¿
                console.log('å±¥æ­´ã‚’å†èª­ã¿è¾¼ã¿ä¸­...');
                showLoading();
                await loadHistory();
                console.log('å±¥æ­´å†èª­ã¿è¾¼ã¿å®Œäº†');
                
            } catch (error) {
                console.error('=== å‰Šé™¤ã‚¨ãƒ©ãƒ¼ ===');
                console.error('ã‚¨ãƒ©ãƒ¼:', error);
                console.error('ã‚¨ãƒ©ãƒ¼ã‚¹ã‚¿ãƒƒã‚¯:', error.stack);
                
                let userMessage = 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\n';
                
                if (error.message.includes('Failed to fetch') || error.message.includes('fetch')) {
                    userMessage += 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚\nã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                } else if (error.message.includes('401')) {
                    userMessage += 'èªè¨¼ã‚¨ãƒ©ãƒ¼: ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™ã€‚';
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 3000);
                } else {
                    userMessage += `ã‚¨ãƒ©ãƒ¼è©³ç´°: ${error.message}`;
                }
                
                alert(userMessage);
            }
        }

        // UIçŠ¶æ…‹ç®¡ç†
        function showLoading() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('historyList').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loadingState').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('errorState').textContent = message;
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('historyList').style.display = 'none';
        }

        function showEmptyState() {
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('historyList').style.display = 'none';
        }

        // æ—¥æ™‚ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°
        function formatDate(timestamp) {
            try {
                const date = new Date(timestamp);
                return date.toLocaleString('ja-JP', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                console.error('Date formatting error:', error);
                return timestamp || 'ä¸æ˜ãªæ—¥æ™‚';
            }
        }

        // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
        function goToChat() {
            window.location.href = 'chat.html';
        }

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½ã¯å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§æä¾›
    </script>
</body>
</html>