<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š - å…ƒæ°—ãƒãƒ£ãƒƒãƒˆ</title>
    <link rel="stylesheet" href="styles.css">
    <script src="components.js"></script>
</head>
<body>
    <div id="app">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ (ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯) -->
        <div class="header" id="headerContainer">
            <div class="header-left">
                <a href="chat.html" class="back-button">
                    <span>â†</span>
                    ãƒãƒ£ãƒƒãƒˆ
                </a>
                <h1>ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</h1>
            </div>
            <div class="hamburger-menu" id="hamburgerMenu">
                <button class="hamburger-button" onclick="toggleMenu()">
                    <div class="hamburger-icon">
                        <div class="hamburger-line"></div>
                        <div class="hamburger-line"></div>
                        <div class="hamburger-line"></div>
                    </div>
                </button>
                <div class="menu-dropdown">
                    <a href="chat.html" class="menu-item">
                        <span class="menu-icon">ğŸ’¬</span>
                        æ–°è¦ãƒãƒ£ãƒƒãƒˆ
                    </a>
                    <a href="profile.html" class="menu-item">
                        <span class="menu-icon">ğŸ‘¤</span>
                        ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
                    </a>
                    <div class="menu-item" onclick="toggleTheme()" id="themeToggle">
                        <span class="menu-icon">ğŸŒ™</span>
                        ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰
                    </div>
                    <div class="menu-item logout" onclick="logout()">
                        <span class="menu-icon">ğŸšª</span>
                        ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                    </div>
                </div>
            </div>
        </div>

        <!-- ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®šç”»é¢ -->
        <div class="container">
            <div class="content">
                <div class="profile-container">
            <h2>ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š</h2>
            <p class="profile-description">ã‚ãªãŸã®æƒ…å ±ã‚’å…¥åŠ›ã™ã‚‹ã“ã¨ã§ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã‚ˆã‚Šé©åˆ‡ãªä¼šè©±ã‚’ã—ã¦ãã‚Œã¾ã™ã€‚</p>
            
            <form id="profileForm" class="profile-form">
                <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼å -->
                <div class="form-group">
                    <label for="userName">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
                    <input type="text" id="userName" name="userName" placeholder="ã©ã®ã‚ˆã†ã«å‘¼ã°ã‚ŒãŸã„ã§ã™ã‹ï¼Ÿ" maxlength="50">
                    <small>ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒã‚ãªãŸã‚’å‘¼ã¶ã¨ãã®åå‰ã§ã™</small>
                </div>

                <!-- å¹´é½¢ -->
                <div class="form-group">
                    <label for="age">å¹´é½¢</label>
                    <select id="age" name="age">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="10ä»£">10ä»£</option>
                        <option value="20ä»£">20ä»£</option>
                        <option value="30ä»£">30ä»£</option>
                        <option value="40ä»£">40ä»£</option>
                        <option value="50ä»£">50ä»£</option>
                        <option value="60ä»£ä»¥ä¸Š">60ä»£ä»¥ä¸Š</option>
                    </select>
                    <small>å¹´é½¢ã«é©ã—ãŸè©±ã—æ–¹ã§ä¼šè©±ã—ã¾ã™</small>
                </div>

                <!-- è·æ¥­ -->
                <div class="form-group">
                    <label for="occupation">è·æ¥­</label>
                    <input type="text" id="occupation" name="occupation" placeholder="ä¾‹ï¼šå­¦ç”Ÿã€ä¼šç¤¾å“¡ã€ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã€ä¸»å©¦ãªã©" maxlength="50">
                    <small>è·æ¥­ã«é–¢é€£ã—ãŸè©±é¡Œã‚„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¾ã™</small>
                </div>

                <!-- æ€§åˆ¥ -->
                <div class="form-group">
                    <label for="gender">æ€§åˆ¥</label>
                    <select id="gender" name="gender">
                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                        <option value="ç”·æ€§">ç”·æ€§</option>
                        <option value="å¥³æ€§">å¥³æ€§</option>
                        <option value="ãã®ä»–">ãã®ä»–</option>
                        <option value="ç­”ãˆãªã„">ç­”ãˆãªã„</option>
                    </select>
                    <small>é©åˆ‡ãªæ•¬èªã‚„è©±ã—æ–¹ã§ä¼šè©±ã—ã¾ã™</small>
                </div>

                <!-- å¿œç­”ã®é•·ã• -->
                <div class="form-group">
                    <label for="responseLength">å¿œç­”ã®é•·ã•</label>
                    <select id="responseLength" name="responseLength">
                        <option value="short">çŸ­ã‚ï¼ˆ1-2è¡Œï¼‰</option>
                        <option value="medium" selected>æ™®é€šï¼ˆ2-4è¡Œï¼‰</option>
                        <option value="long">è©³ã—ãï¼ˆ4-8è¡Œï¼‰</option>
                    </select>
                    <small>ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®è¿”ä¿¡ã®é•·ã•ã‚’è¨­å®šã§ãã¾ã™</small>
                </div>

                <!-- ä¿å­˜ãƒœã‚¿ãƒ³ -->
                <div class="form-actions">
                    <button type="submit" class="save-btn" id="saveBtn">ğŸ’¾ è¨­å®šã‚’ä¿å­˜</button>
                    <button type="button" class="reset-btn" id="resetBtn">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
                </div>
            </form>

                <!-- ä¿å­˜çŠ¶æ³ -->
                <div id="saveStatus" class="save-status"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Profile page initialized');
            
            // ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®åˆæœŸåŒ–
            if (window.componentManager) {
                try {
                    window.componentManager.initializeCommon();
                    console.log('ComponentManager initialized successfully');
                } catch (error) {
                    console.error('ComponentManager initialization failed:', error);
                }
            }
            
            // ãƒ†ãƒ¼ãƒåˆæœŸåŒ–
            initializeTheme();
            
            // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ©Ÿèƒ½ã®åˆæœŸåŒ–
            initializeProfile();
        });

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«æ©Ÿèƒ½
        function initializeProfile() {
            // ä¿å­˜ã•ã‚ŒãŸãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã¿
            loadProfile();
            
            // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚¤ãƒ™ãƒ³ãƒˆ
            document.getElementById('profileForm').addEventListener('submit', saveProfile);
            
            // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
            document.getElementById('resetBtn').addEventListener('click', resetProfile);
        }

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«èª­ã¿è¾¼ã¿
        async function loadProfile() {
            try {
                // ã¾ãšã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰èª­ã¿è¾¼ã¿ã‚’è©¦è¡Œ
                await loadProfileFromServer();
                
                // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰èª­ã¿è¾¼ã‚ãªã‹ã£ãŸå ´åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰
                const profile = JSON.parse(localStorage.getItem('userProfile') || '{}');
                
                // ãƒ•ã‚©ãƒ¼ãƒ ãŒã¾ã ç©ºã®å ´åˆã®ã¿ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
                if (!document.getElementById('userName').value && profile.userName) {
                    document.getElementById('userName').value = profile.userName;
                }
                if (!document.getElementById('age').value && profile.age) {
                    document.getElementById('age').value = profile.age;
                }
                if (!document.getElementById('occupation').value && profile.occupation) {
                    document.getElementById('occupation').value = profile.occupation;
                }
                if (!document.getElementById('gender').value && profile.gender) {
                    document.getElementById('gender').value = profile.gender;
                }
                if (!document.getElementById('responseLength').value && profile.responseLength) {
                    document.getElementById('responseLength').value = profile.responseLength;
                }
                
                console.log('Profile loaded:', profile);
            } catch (error) {
                console.error('Failed to load profile:', error);
            }
        }

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜
        async function saveProfile(event) {
            event.preventDefault();
            
            const saveBtn = document.getElementById('saveBtn');
            const statusDiv = document.getElementById('saveStatus');
            
            try {
                saveBtn.disabled = true;
                saveBtn.textContent = 'ğŸ’¾ ä¿å­˜ä¸­...';
                
                // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const formData = new FormData(event.target);
                const profile = {
                    userName: formData.get('userName') || '',
                    age: formData.get('age') || '',
                    occupation: formData.get('occupation') || '',
                    gender: formData.get('gender') || '',
                    responseLength: formData.get('responseLength') || 'medium',
                    updatedAt: new Date().toISOString()
                };
                
                console.log('Saving profile:', profile);
                
                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                localStorage.setItem('userProfile', JSON.stringify(profile));
                
                // ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜
                await saveProfileToServer(profile);
                
                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                showStatus('âœ… ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼', 'success');
                
            } catch (error) {
                console.error('Failed to save profile:', error);
                showStatus('âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'ğŸ’¾ è¨­å®šã‚’ä¿å­˜';
            }
        }

        // ã‚µãƒ¼ãƒãƒ¼ã«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ä¿å­˜
        async function saveProfileToServer(profile) {
            const token = localStorage.getItem('idToken');
            if (!token) {
                throw new Error('èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“');
            }

            const response = await fetch('https://i6zlozpitk.execute-api.ap-northeast-1.amazonaws.com/prod/chat/profile', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(profile)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            }

            const result = await response.json();
            console.log('Profile saved to server:', result);
            return result;
        }

        // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã¿
        async function loadProfileFromServer() {
            try {
                const token = localStorage.getItem('idToken');
                if (!token) {
                    console.log('èªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã™ã€‚');
                    return;
                }

                const response = await fetch('https://i6zlozpitk.execute-api.ap-northeast-1.amazonaws.com/prod/chat/profile', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const profile = await response.json();
                    console.log('Profile loaded from server:', profile);
                    
                    // ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
                    if (profile.userName) document.getElementById('userName').value = profile.userName;
                    if (profile.age) document.getElementById('age').value = profile.age;
                    if (profile.occupation) document.getElementById('occupation').value = profile.occupation;
                    if (profile.gender) document.getElementById('gender').value = profile.gender;
                    if (profile.responseLength) document.getElementById('responseLength').value = profile.responseLength;
                    
                    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚‚æ›´æ–°
                    localStorage.setItem('userProfile', JSON.stringify(profile));
                } else {
                    console.log('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã™ã€‚');
                }
            } catch (error) {
                console.error('Failed to load profile from server:', error);
                console.log('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã€‚ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã™ã€‚');
            }
        }

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒªã‚»ãƒƒãƒˆ
        function resetProfile() {
            if (confirm('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                document.getElementById('profileForm').reset();
                document.getElementById('responseLength').value = 'medium';
                localStorage.removeItem('userProfile');
                showStatus('ğŸ”„ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸ', 'info');
            }
        }

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
        function showStatus(message, type) {
            const statusDiv = document.getElementById('saveStatus');
            statusDiv.textContent = message;
            statusDiv.className = `save-status ${type}`;
            
            setTimeout(() => {
                statusDiv.textContent = '';
                statusDiv.className = 'save-status';
            }, 3000);
        }

        // ãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆé–¢æ•°
        function toggleTheme() {
            const currentTheme = document.body.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ãƒ†ãƒ¼ãƒãƒˆã‚°ãƒ«ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
            const themeToggle = document.getElementById('themeToggle');
            if (themeToggle) {
                const icon = newTheme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
                const text = newTheme === 'light' ? 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰' : 'ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰';
                themeToggle.innerHTML = `<span class="menu-icon">${icon}</span> ${text}`;
            }
        }

        // ãƒ†ãƒ¼ãƒåˆæœŸåŒ–é–¢æ•°
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', savedTheme);
            
            // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ãƒ†ãƒ¼ãƒãƒˆã‚°ãƒ«ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
            setTimeout(() => {
                const themeToggle = document.getElementById('themeToggle');
                if (themeToggle) {
                    const icon = savedTheme === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
                    const text = savedTheme === 'dark' ? 'ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰' : 'ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰';
                    themeToggle.innerHTML = `<span class="menu-icon">${icon}</span> ${text}`;
                }
            }, 100);
        }

        // ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆ
        function toggleMenu() {
            const menu = document.getElementById('hamburgerMenu');
            menu.classList.toggle('active');
        }

        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('hamburgerMenu');
            if (menu && !menu.contains(event.target)) {
                menu.classList.remove('active');
            }
        });

        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆé–¢æ•°
        function logout() {
            if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = 'index.html';
            }
        }
    </script>
</body>
</html>