<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS Chat - ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="common.css">
</head>
<body>
    <div class="container" id="app">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ (ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§å‹•çš„ç”Ÿæˆ) -->
        <div id="headerContainer"></div>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="content">
            <div class="profile-container">
                <h2>ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š</h2>
                <p class="profile-description">
                    ã‚ãªãŸã®æƒ…å ±ã‚’å…¥åŠ›ã™ã‚‹ã“ã¨ã§ã€AIãŒã‚ˆã‚Šé©åˆ‡ãªä¼šè©±ã‚’ã—ã¦ãã‚Œã¾ã™ã€‚<br>
                    ã™ã¹ã¦ã®é …ç›®ã¯ä»»æ„ã§ã™ã€‚ã„ã¤ã§ã‚‚å¤‰æ›´ã§ãã¾ã™ã€‚
                </p>
                
                <form id="profileForm" class="profile-form">
                    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼å -->
                    <div class="form-group">
                        <label for="userName">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
                        <input type="text" id="userName" name="userName" class="form-input" 
                               placeholder="ã©ã®ã‚ˆã†ã«å‘¼ã°ã‚ŒãŸã„ã§ã™ã‹ï¼Ÿ" maxlength="50">
                        <small>AIãŒã‚ãªãŸã‚’å‘¼ã¶ã¨ãã®åå‰ã§ã™</small>
                    </div>

                    <!-- å¹´é½¢ -->
                    <div class="form-group">
                        <label for="age">å¹´é½¢</label>
                        <select id="age" name="age" class="form-input">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="10ä»£">10ä»£</option>
                            <option value="20ä»£">20ä»£</option>
                            <option value="30ä»£">30ä»£</option>
                            <option value="40ä»£">40ä»£</option>
                            <option value="50ä»£">50ä»£</option>
                            <option value="60ä»£ä»¥ä¸Š">60ä»£ä»¥ä¸Š</option>
                        </select>
                        <small>å¹´é½¢ã«é©ã—ãŸè©±ã—æ–¹ã§ä¼šè©±ã—ã¾ã™</small>
                    </div>

                    <!-- è·æ¥­ -->
                    <div class="form-group">
                        <label for="occupation">è·æ¥­</label>
                        <input type="text" id="occupation" name="occupation" class="form-input" 
                               placeholder="ä¾‹ï¼šå­¦ç”Ÿã€ä¼šç¤¾å“¡ã€ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã€ä¸»å©¦ãªã©" maxlength="50">
                        <small>è·æ¥­ã«é–¢é€£ã—ãŸè©±é¡Œã‚„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¾ã™</small>
                    </div>

                    <!-- æ€§åˆ¥ -->
                    <div class="form-group">
                        <label for="gender">æ€§åˆ¥</label>
                        <select id="gender" name="gender" class="form-input">
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="ç”·æ€§">ç”·æ€§</option>
                            <option value="å¥³æ€§">å¥³æ€§</option>
                            <option value="ãã®ä»–">ãã®ä»–</option>
                            <option value="ç­”ãˆãªã„">ç­”ãˆãªã„</option>
                        </select>
                        <small>é©åˆ‡ãªæ•¬èªã‚„è©±ã—æ–¹ã§ä¼šè©±ã—ã¾ã™</small>
                    </div>

                    <!-- å¿œç­”ã®é•·ã• -->
                    <div class="form-group">
                        <label for="responseLength">å¿œç­”ã®é•·ã•</label>
                        <select id="responseLength" name="responseLength" class="form-input">
                            <option value="short">çŸ­ã‚ï¼ˆ1-2è¡Œï¼‰</option>
                            <option value="medium" selected>æ™®é€šï¼ˆ2-4è¡Œï¼‰</option>
                            <option value="long">è©³ã—ãï¼ˆ4-8è¡Œï¼‰</option>
                        </select>
                        <small>AIã®è¿”ä¿¡ã®é•·ã•ã‚’è¨­å®šã§ãã¾ã™</small>
                    </div>

                    <!-- ãƒœã‚¿ãƒ³ -->
                    <div class="form-actions">
                        <button type="submit" class="btn-primary" id="saveBtn">ğŸ’¾ è¨­å®šã‚’ä¿å­˜</button>
                        <button type="button" class="btn-secondary" id="resetBtn">ğŸ”„ ãƒªã‚»ãƒƒãƒˆ</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script src="components.js"></script>
    <script src="auth.js"></script>
    <script>
        // ãƒšãƒ¼ã‚¸åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Profile page initializing...');
            
            // èªè¨¼ãƒã‚§ãƒƒã‚¯
            if (!initializeApp()) {
                return;
            }

            try {
                await initializeProfile();
            } catch (error) {
                console.error('Profile initialization failed:', error);
                UIUtils.showError('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ', error.message);
            }
        });

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸åˆæœŸåŒ–
        async function initializeProfile() {
            // ãƒ˜ãƒƒãƒ€ãƒ¼åˆæœŸåŒ–
            initializeHeader();
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            setupEventListeners();
            
            // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«èª­ã¿è¾¼ã¿
            await loadProfile();
            
            console.log('Profile page initialized successfully');
        }

        // ãƒ˜ãƒƒãƒ€ãƒ¼åˆæœŸåŒ–
        function initializeHeader() {
            const headerContainer = document.getElementById('headerContainer');
            headerContainer.innerHTML = componentManager.createHeader({
                title: 'ğŸ‘¤ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«',
                showBackButton: true,
                backUrl: 'chat-clean.html',
                backText: 'ãƒãƒ£ãƒƒãƒˆ'
            });
            
            // ComponentManagerã®å…±é€šæ©Ÿèƒ½ã‚’åˆæœŸåŒ–
            componentManager.initializeCommon();
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function setupEventListeners() {
            // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
            document.getElementById('profileForm').addEventListener('submit', handleProfileSave);
            
            // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³
            document.getElementById('resetBtn').addEventListener('click', handleProfileReset);
        }

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«èª­ã¿è¾¼ã¿
        async function loadProfile() {
            try {
                // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã¿
                const serverProfile = await profileManager.getProfile();
                
                if (serverProfile && Object.keys(serverProfile).length > 0) {
                    fillForm(serverProfile);
                    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚‚æ›´æ–°
                    profileManager.saveLocalProfile(serverProfile);
                } else {
                    // ã‚µãƒ¼ãƒãƒ¼ã«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒãªã„å ´åˆã€ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿
                    const localProfile = profileManager.getLocalProfile();
                    if (Object.keys(localProfile).length > 0) {
                        fillForm(localProfile);
                    }
                }
                
            } catch (error) {
                console.error('Failed to load profile from server:', error);
                // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ãŸå ´åˆã€ãƒ­ãƒ¼ã‚«ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã¿
                const localProfile = profileManager.getLocalProfile();
                if (Object.keys(localProfile).length > 0) {
                    fillForm(localProfile);
                    UIUtils.showStatus('ãƒ­ãƒ¼ã‚«ãƒ«ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'info', 2000);
                }
            }
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›
        function fillForm(profile) {
            if (profile.userName) document.getElementById('userName').value = profile.userName;
            if (profile.age) document.getElementById('age').value = profile.age;
            if (profile.occupation) document.getElementById('occupation').value = profile.occupation;
            if (profile.gender) document.getElementById('gender').value = profile.gender;
            if (profile.responseLength) document.getElementById('responseLength').value = profile.responseLength;
        }

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ä¿å­˜å‡¦ç†
        async function handleProfileSave(event) {
            event.preventDefault();
            
            const saveBtn = document.getElementById('saveBtn');
            const originalText = saveBtn.textContent;
            
            try {
                // UIæ›´æ–°
                saveBtn.disabled = true;
                saveBtn.textContent = 'ğŸ’¾ ä¿å­˜ä¸­...';
                
                // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿å–å¾—
                const formData = new FormData(event.target);
                const profile = {
                    userName: formData.get('userName') || '',
                    age: formData.get('age') || '',
                    occupation: formData.get('occupation') || '',
                    gender: formData.get('gender') || '',
                    responseLength: formData.get('responseLength') || 'medium',
                    updatedAt: new Date().toISOString()
                };
                
                console.log('Saving profile:', profile);
                
                // ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜
                profileManager.saveLocalProfile(profile);
                
                // ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜
                await profileManager.saveProfile(profile);
                
                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                UIUtils.showStatus('âœ… ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼', 'success');
                
            } catch (error) {
                console.error('Failed to save profile:', error);
                UIUtils.showStatus('âŒ ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
            } finally {
                // UIå¾©å…ƒ
                saveBtn.disabled = false;
                saveBtn.textContent = originalText;
            }
        }

        // ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒªã‚»ãƒƒãƒˆå‡¦ç†
        function handleProfileReset() {
            if (confirm('ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                document.getElementById('profileForm').reset();
                document.getElementById('responseLength').value = 'medium';
                
                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ã‚‚å‰Šé™¤
                localStorage.removeItem('userProfile');
                
                UIUtils.showStatus('ğŸ”„ ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸ', 'info');
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹
        window.loadProfile = loadProfile;
    </script>

    <style>
        /* ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .profile-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 2rem;
        }

        .profile-container h2 {
            font-size: 1.8rem;
            font-weight: 300;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #6366f1, #8b5cf6, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .profile-description {
            color: #94a3b8;
            margin-bottom: 2rem;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .profile-form {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 500;
            color: #e4e4e7;
            font-size: 0.95rem;
        }

        .form-group small {
            font-size: 0.8rem;
            color: #94a3b8;
            opacity: 0.9;
            margin-top: 0.25rem;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .form-actions .btn-primary,
        .form-actions .btn-secondary {
            flex: 1;
            justify-content: center;
        }

        /* ãƒ©ã‚¤ãƒˆãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ */
        body[data-theme="light"] .profile-description {
            color: #64748b;
        }

        body[data-theme="light"] .form-group label {
            color: #334155;
        }

        body[data-theme="light"] .form-group small {
            color: #64748b;
        }

        /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
        @media (max-width: 768px) {
            .profile-container {
                margin: 1rem;
                padding: 1.5rem;
            }
            
            .form-actions {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .form-actions .btn-primary,
            .form-actions .btn-secondary {
                flex: none;
            }
        }
    </style>
</body>
</html>