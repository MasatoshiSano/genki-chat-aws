<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEXUS Chat</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- NEXUS Chat Header -->
    <div id="headerContainer">
        <div class="header">
            <div class="header-left">
                <h1>💫 NEXUS Chat</h1>
            </div>
        </div>
    </div>
    
    <div class="container">
        <div class="content">
            <div class="login-container">
                <div class="logo">💫</div>
                <h2>NEXUS Chat</h2>
                <p class="subtitle">あなたの毎日を明るくするAIアシスタント</p>
        
                <!-- ログインフォーム -->
                <div class="login-form" id="loginForm">
                    <input type="email" id="email" placeholder="メールアドレス" required>
                    <input type="password" id="password" placeholder="パスワード" required>
                    <button onclick="login()" id="loginButton" class="login-btn">ログイン</button>
                    <a href="#" class="signup-link" onclick="showSignup()">新規登録はこちら</a>
                </div>
                
                <!-- 新規登録フォーム -->
                <div class="login-form form-toggle" id="signupForm">
                    <input type="email" id="signupEmail" placeholder="メールアドレス" required>
                    <input type="password" id="signupPassword" placeholder="パスワード（8文字以上）" required>
                    <input type="password" id="confirmPassword" placeholder="パスワード（再入力）" required>
                    <button onclick="signup()" id="signupButton" class="login-btn">新規登録</button>
                    <a href="#" class="signup-link" onclick="showLogin()">ログインに戻る</a>
                </div>
                
                <!-- 確認コード入力フォーム -->
                <div class="login-form form-toggle" id="confirmForm">
                    <p class="subtitle">メールに送信された確認コードを入力してください</p>
                    <input type="text" id="confirmationCode" placeholder="確認コード" required>
                    <button onclick="confirmSignup()" id="confirmButton" class="login-btn">アカウントを有効化</button>
                    <a href="#" class="signup-link" onclick="showLogin()">ログインに戻る</a>
                </div>
                
                <div id="status" class="status"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="auth.js"></script>
    <script>
        // Cognito設定
        const COGNITO_CONFIG = {
            userPoolId: 'ap-northeast-1_7CLrXZQiB',
            clientId: '7af0tuk3i9r0lir5uhqduiep04',
            clientSecret: '1t87e432carkn9lg6i4tjhmj8brkf7mp1vj8phqhkuljpqtqtnia',
            region: 'ap-northeast-1'
        };
        
        // Cognito認証インスタンス
        const cognitoAuth = new CognitoAuth(COGNITO_CONFIG);
        let pendingEmail = '';

        // ページ読み込み時にセッションを確認
        document.addEventListener('DOMContentLoaded', function() {
            if (cognitoAuth.restoreSession()) {
                // 既にログイン済みの場合はチャットページに遷移
                window.location.href = 'chat.html';
            }
        });

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
        }
        
        function hideStatus() {
            document.getElementById('status').style.display = 'none';
        }
        
        function showLogin() {
            document.getElementById('loginForm').style.display = 'flex';
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('confirmForm').style.display = 'none';
            hideStatus();
        }
        
        function showSignup() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'flex';
            document.getElementById('confirmForm').style.display = 'none';
            hideStatus();
        }
        
        function showConfirm() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('confirmForm').style.display = 'flex';
            hideStatus();
        }

        async function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showStatus('メールアドレスとパスワードを入力してください', 'error');
                return;
            }
            
            const button = document.getElementById('loginButton');
            button.disabled = true;
            button.textContent = 'ログイン中...';
            
            try {
                const result = await cognitoAuth.signIn(email, password);
                
                if (result.success) {
                    showStatus('ログイン成功！チャットページに遷移中...', 'success');
                    setTimeout(() => {
                        window.location.href = 'chat.html';
                    }, 1000);
                } else {
                    showStatus(result.error || 'ログインに失敗しました', 'error');
                }
            } catch (error) {
                showStatus('ログインエラー: ' + error.message, 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'ログイン';
            }
        }
        
        async function signup() {
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!email || !password || !confirmPassword) {
                showStatus('すべての項目を入力してください', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showStatus('パスワードが一致しません', 'error');
                return;
            }
            
            if (password.length < 8) {
                showStatus('パスワードは8文字以上で入力してください', 'error');
                return;
            }
            
            const button = document.getElementById('signupButton');
            button.disabled = true;
            button.textContent = '登録中...';
            
            try {
                const result = await cognitoAuth.signUp(email, password, {
                    email: email
                });
                
                if (result.success) {
                    pendingEmail = email;
                    showStatus('登録成功！メールに確認コードを送信しました', 'success');
                    setTimeout(() => {
                        showConfirm();
                    }, 2000);
                } else {
                    showStatus(result.error || '登録に失敗しました', 'error');
                }
            } catch (error) {
                showStatus('登録エラー: ' + error.message, 'error');
            } finally {
                button.disabled = false;
                button.textContent = '新規登録';
            }
        }
        
        async function confirmSignup() {
            const code = document.getElementById('confirmationCode').value;
            
            if (!code) {
                showStatus('確認コードを入力してください', 'error');
                return;
            }
            
            const button = document.getElementById('confirmButton');
            button.disabled = true;
            button.textContent = '確認中...';
            
            try {
                const result = await cognitoAuth.confirmSignUp(pendingEmail, code);
                
                if (result.success) {
                    showStatus('アカウントの有効化が完了しました！ログインしてください', 'success');
                    setTimeout(() => {
                        showLogin();
                    }, 2000);
                } else {
                    showStatus(result.error || '確認に失敗しました', 'error');
                }
            } catch (error) {
                showStatus('確認エラー: ' + error.message, 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'アカウントを有効化';
            }
        }
    </script>
</body>
</html>